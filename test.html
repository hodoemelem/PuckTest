 <html>
<body>
<button onclick="connect()">Connect to Web Bluetooth9</button>
<div id="data"></div>
<script>
 

let readBuffer = '';//temp buffer
 
function connect() {
  var options =  {
    filters: [
      {namePrefix: 'Bangle.js 4531'},
    ],
    optionalServices: [ "4faf0001-1fb5-459e-8fcc-c5c9c331914b" ]
  };
  var busy = false;
  var gatt, service;
  navigator.bluetooth.requestDevice(options).then(function(device) {
    console.log('Device: ' + JSON.stringify(device));
    return device.gatt.connect();
  }).then(function(g) {
   gatt = g;
   // Get our custom service
   return gatt.getPrimaryService("4faf0001-1fb5-459e-8fcc-c5c9c331914b");
  }).then(function(s) {
    service = s;
    // Get the Acceleorometer characteristic
    return service.getCharacteristic("4faf0002-1fb5-459e-8fcc-c5c9c331914b");
  }).then(function(characteristic) {
    var dataDiv = document.querySelector("#data");
    // When we get a notification, write the data to a div below the button
    characteristic.addEventListener('characteristicvaluechanged',handleChangedValue);
    // Now start getting notifications
    return characteristic.startNotifications();
  }).then(function() {
    //gatt.disconnect();
    console.log("Done!");
  }).catch(function(error) {
    console.log("Something went wrong. " + error);
  });
}
 
function handleChangedValue(event) {
    ///var Data =event.target.value//.getUint8(0)
    let data = new TextDecoder('windows-1252').decode(event.target.value);
    //let data = new TextDecoder().decodeURIComponent(escape(event.target.value));
   
    // var encodedata = new TextEncoder("windows-1252",{ NONSTANDARD_allowLegacyEncoding: true }).encode(event.target.value);
    console.log(data)
	
	if(data === "StOpBaNgLeJsNoW"){
		saveTextAsFile(readBuffer);
              readBuffer = '';	
	}
	else{readBuffer += data;}
	
 
  }
 
function saveTextAsFile(data)
{
	var encodedata = new TextEncoder("windows-1252",{ NONSTANDARD_allowLegacyEncoding: true }).encode(data);
  let a = document.createElement('a');
//a.href = "data:application/octet-stream,"+encodeURIComponent(data);
a.href = "data:application/octet-stream,"+ encodedata;
a.download = 'AccData.txt';
a.click();
}
 

 
</script>
</body>
</html>



  
  

